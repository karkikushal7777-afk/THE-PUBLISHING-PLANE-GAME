<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sky Dodger: Pro Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #4ca1af; background: linear-gradient(to bottom, #2c3e50, #4ca1af); font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        
        #hud {
            position: fixed; top: 15px; left: 15px; color: #fff;
            font-size: 22px; font-weight: bold; pointer-events: none; z-index: 5;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #menu {
            position: fixed; inset: 0; background: rgba(0, 10, 20, 0.85);
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }
        .container {
            background: white; padding: 30px; border-radius: 20px;
            text-align: center; border: 5px solid #4cc9f0; width: 400px;
            box-shadow: 0 0 30px rgba(76, 201, 240, 0.4);
        }
        .btn {
            padding: 10px 15px; margin: 5px; cursor: pointer; border: 2px solid #4cc9f0;
            background: transparent; color: #4cc9f0; border-radius: 8px; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { background: rgba(76, 201, 240, 0.1); }
        .btn.active { background: #4cc9f0; color: white; }
        .btn-chaos { border-color: #ff4d6d; color: #ff4d6d; }
        .btn-chaos.active { background: #ff4d6d; color: white; }

        .hangar { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 20px 0; }
        .slot { border: 2px solid #eee; padding: 10px; cursor: pointer; border-radius: 10px; font-size: 11px; transition: 0.2s; }
        .slot:hover { transform: translateY(-3px); }
        .slot.selected { border-color: #ffd60a; background: #fff9db; box-shadow: 0 5px 15px rgba(255, 214, 10, 0.3); }
        .start-btn {
            background: #ff4d6d; color: white; border: none; padding: 15px 50px;
            font-size: 20px; font-weight: bold; border-radius: 40px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 77, 109, 0.4);
        }
    </style>
</head>
<body>

<div id="hud">
    COINS: <span id="coinVal">0</span> | 
    SCORE: <span id="scoreVal">0</span> | 
    MISSILES: <span id="mCount">0</span>
</div>

<div id="menu">
    <div class="container">
        <h1 style="color: #0077be; margin: 0 0 5px 0; letter-spacing: 2px;">SKY DODGER</h1>
        <p style="margin-bottom: 20px; color: #666;">High-Altitude Interception</p>
        <p>Bank: <span id="bankVal" style="color:#f39c12; font-weight: bold;">0</span> C</p>
        <div class="mode-select">
            <button id="easyBtn" class="btn active" onclick="setMode('easy')">EASY</button>
            <button id="hardBtn" class="btn" onclick="setMode('hard')">HARD</button>
            <button id="chaosBtn" class="btn btn-chaos" onclick="setMode('chaos')">CHAOS</button>
        </div>
        <div class="hangar" id="hangar"></div>
        <button class="start-btn" onclick="startGame()">ENGAGE</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let mode = 'easy';
let coins = parseInt(localStorage.getItem('sky_coins')) || 0;
let unlocked = JSON.parse(localStorage.getItem('sky_ships')) || ['Classic'];
let activeShip = localStorage.getItem('sky_active') || 'Classic';

const SHIPS = {
    'Classic': { color: '#bdc3c7', accent: '#c0392b', speed: 0.65, turn: 0.12, price: 0 },
    'Viper':   { color: '#f1c40f', accent: '#2c3e50', speed: 0.85, turn: 0.16, price: 100 },
    'Falcon':  { color: '#3498db', accent: '#2980b9', speed: 0.75, turn: 0.2, price: 250 }
};

let isRunning = false, score = 0, frame = 0, camX = 0, camY = 0, shake = 0, zoom = 0.6;
let keys = {};
const player = { x: 0, y: 0, vx: 0, vy: 0, angle: 0 };
let missiles = [], loot = [], particles = [], clouds = [];

// Initialize Clouds
for(let i=0; i<25; i++) {
    clouds.push({
        x: Math.random() * 5000 - 2500,
        y: Math.random() * 5000 - 2500,
        w: 200 + Math.random() * 400,
        h: 100 + Math.random() * 150,
        opacity: 0.1 + Math.random() * 0.3
    });
}

function setMode(m) {
    mode = m;
    document.getElementById('easyBtn').className = m === 'easy' ? 'btn active' : 'btn';
    document.getElementById('hardBtn').className = m === 'hard' ? 'btn active' : 'btn';
    document.getElementById('chaosBtn').className = m === 'chaos' ? 'btn btn-chaos active' : 'btn btn-chaos';
}

function updateHangar() {
    const gui = document.getElementById('hangar');
    gui.innerHTML = '';
    for (let s in SHIPS) {
        let isOwn = unlocked.includes(s);
        let div = document.createElement('div');
        div.className = `slot ${activeShip === s ? 'selected' : ''}`;
        div.innerHTML = `<b>${s}</b><br>${isOwn ? 'READY' : SHIPS[s].price + ' C'}`;
        div.onclick = () => {
            if (isOwn) { activeShip = s; } 
            else if (coins >= SHIPS[s].price) {
                coins -= SHIPS[s].price; unlocked.push(s); activeShip = s;
                save();
            }
            updateHangar(); syncUI();
        };
        gui.appendChild(div);
    }
}

function save() {
    localStorage.setItem('sky_coins', coins);
    localStorage.setItem('sky_ships', JSON.stringify(unlocked));
    localStorage.setItem('sky_active', activeShip);
}

function syncUI() {
    document.getElementById('bankVal').innerText = coins;
    document.getElementById('coinVal').innerText = coins;
    document.getElementById('scoreVal').innerText = score;
    document.getElementById('mCount').innerText = missiles.length;
}

function spawnExplosion(x, y) {
    shake = 35;
    for(let i=0; i<40; i++) {
        particles.push({ 
            x, y, vx: (Math.random()-0.5)*18, vy: (Math.random()-0.5)*18, 
            life: 1.0, color: i % 2 == 0 ? '#ffae00' : '#ffffff', size: 12 
        });
    }
}

function startGame() {
    isRunning = true; score = 0; frame = 0; zoom = 0.6;
    missiles = []; loot = []; particles = [];
    player.x = 0; player.y = 0; player.vx = 0; player.vy = 0;
    document.getElementById('menu').style.display = 'none';
    requestAnimationFrame(loop);
}

function loop() {
    if (!isRunning) return;
    frame++;

    // Dynamic Zoom Logic
    let speed = Math.hypot(player.vx, player.vy);
    let targetZoom = 0.6 - (speed * 0.005);
    zoom += (targetZoom - zoom) * 0.05;

    // Background Sky
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.fillStyle = "#4ca1af";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (shake > 0) { ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake); shake *= 0.9; }

    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(zoom, zoom); 
    ctx.translate(-camX, -camY);

    // Render Clouds (Parallax)
    clouds.forEach(c => {
        ctx.fillStyle = `rgba(255, 255, 255, ${c.opacity})`;
        ctx.beginPath();
        ctx.ellipse(c.x, c.y, c.w, c.h, 0, 0, 7);
        ctx.fill();
        // Reposition clouds if far away
        if (Math.abs(player.x - c.x) > 3500) c.x = player.x + (player.x > c.x ? 3500 : -3500);
        if (Math.abs(player.y - c.y) > 3500) c.y = player.y + (player.y > c.y ? 3500 : -3500);
    });

    const s = SHIPS[activeShip];
    if (keys['w'] || keys['arrowup']) player.vy -= s.speed;
    if (keys['s'] || keys['arrowdown']) player.vy += s.speed;
    if (keys['a'] || keys['arrowleft']) player.vx -= s.speed;
    if (keys['d'] || keys['arrowright']) player.vx += s.speed;
    player.vx *= 0.96; player.vy *= 0.96;
    player.x += player.vx; player.y += player.vy;
    
    if (Math.hypot(player.vx, player.vy) > 0.2) player.angle = Math.atan2(player.vy, player.vx);
    camX += (player.x - camX) * 0.1; camY += (player.y - camY) * 0.1;

    // Coins
    if (frame % 150 === 0) loot.push({ x: player.x + (Math.random()-0.5)*4000, y: player.y + (Math.random()-0.5)*4000 });
    for (let i = loot.length-1; i >= 0; i--) {
        let l = loot[i];
        // Glow effect for coins
        ctx.shadowBlur = 15; ctx.shadowColor = "#ffd60a";
        ctx.fillStyle = "#ffd60a"; ctx.beginPath(); ctx.arc(l.x, l.y, 25, 0, 6.28); ctx.fill();
        ctx.shadowBlur = 0;
        if (Math.hypot(player.x-l.x, player.y-l.y) < 70) {
            coins += 10; score += 50; loot.splice(i, 1); syncUI(); save();
        }
    }

    // Missile Logic
    let baseRate = mode === 'easy' ? 95 : (mode === 'hard' ? 55 : 22);
    let ramp = Math.floor(frame / 600);
    if (frame % Math.max(12, baseRate - ramp) === 0) {
        let a = Math.random()*6.28;
        missiles.push({ x: player.x+Math.cos(a)*1500, y: player.y+Math.sin(a)*1500, angle: a+Math.PI, speed: 10, trail: [] });
        syncUI();
    }

    for (let i = missiles.length-1; i >= 0; i--) {
        let m = missiles[i];
        let target = Math.atan2(player.y - m.y, player.x - m.x);
        let diff = target - m.angle;
        while(diff < -Math.PI) diff += Math.PI*2;
        while(diff > Math.PI) diff -= Math.PI*2;
        m.angle += diff * 0.048;
        m.x += Math.cos(m.angle) * m.speed; m.y += Math.sin(m.angle) * m.speed;

        // Visual Trail
        if (frame % 3 === 0) {
            m.trail.push({x: m.x, y: m.y});
            if (m.trail.length > 12) m.trail.shift();
        }
        ctx.strokeStyle = "rgba(255, 255, 255, 0.4)";
        ctx.lineWidth = 6;
        ctx.beginPath();
        m.trail.forEach(t => ctx.lineTo(t.x, t.y));
        ctx.stroke();

        // Warning Arrows for off-screen missiles
        let dx = m.x - player.x; let dy = m.y - player.y;
        if (Math.abs(dx) > 1000 || Math.abs(dy) > 700) {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, canvas.width/2, canvas.height/2);
            let indicatorAngle = Math.atan2(dy, dx);
            ctx.rotate(indicatorAngle);
            ctx.fillStyle = "rgba(255, 0, 0, 0.6)";
            ctx.beginPath(); ctx.moveTo(250, -10); ctx.lineTo(270, 0); ctx.lineTo(250, 10); ctx.fill();
            ctx.restore();
        }

        // Missile Texture
        ctx.save(); ctx.translate(m.x, m.y); ctx.rotate(m.angle);
        ctx.fillStyle = "#ff5500"; ctx.beginPath(); ctx.arc(-22, 0, 12, 0, 7); ctx.fill();
        ctx.fillStyle = "#333"; ctx.fillRect(-20, -8, 45, 16);
        ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(25, -8); ctx.lineTo(48, 0); ctx.lineTo(25, 8); ctx.fill();
        ctx.restore();

        if (Math.hypot(player.x-m.x, player.y-m.y) < 35) { spawnExplosion(player.x, player.y); isRunning = false; }

        for (let j = i-1; j >= 0; j--) {
            if (Math.hypot(m.x - missiles[j].x, m.y - missiles[j].y) < 60) {
                missiles.splice(i, 1); missiles.splice(j, 1);
                score += 100; syncUI(); break; 
            }
        }
        if (m && Math.hypot(player.x-m.x, player.y-m.y) > 4500) { missiles.splice(i, 1); syncUI(); }
    }

    // Particles
    for (let i = particles.length-1; i >= 0; i--) {
        let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.04;
        ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size * p.life, 0, 6.28); ctx.fill();
        if (p.life <= 0) particles.splice(i, 1);
    }
    ctx.globalAlpha = 1;

    // Plane Texture (With Glass Reflection)
    ctx.save(); ctx.translate(player.x, player.y); ctx.rotate(player.angle);
    ctx.fillStyle = s.accent; ctx.beginPath(); ctx.moveTo(-22, -38); ctx.lineTo(8, 0); ctx.lineTo(-22, 38); ctx.fill();
    ctx.fillStyle = s.color; ctx.beginPath(); ctx.ellipse(0, 0, 38, 14, 0, 0, 7); ctx.fill();
    ctx.fillStyle = "#2c3e50"; ctx.beginPath(); ctx.ellipse(15, 0, 14, 7, 0, 0, 7); ctx.fill();
    ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.beginPath(); ctx.ellipse(18, -3, 6, 2, 0.4, 0, 7); ctx.fill();
    ctx.restore();

    if (!isRunning) { setTimeout(() => { document.getElementById('menu').style.display = 'flex'; syncUI(); }, 1200); }
    else { requestAnimationFrame(loop); }
}

window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;
window.onresize = () => { canvas.width = innerWidth; canvas.height = innerHeight; };
window.onresize(); updateHangar(); syncUI();
</script>
</body>
</html>